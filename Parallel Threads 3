package com.browserstack.assignment;


import org.openqa.selenium.By;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.remote.RemoteWebDriver;
import org.openqa.selenium.remote.DesiredCapabilities;
import org.openqa.selenium.MutableCapabilities;

import java.net.URL;
import java.util.*;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;


public class ParallelElPaisTest  {
	
	public static void main(String[] args) {
        List<Map<String, Object>> capabilitiesList = List.of(
                Map.of(
                        "browserName", "Chrome",
                        "bstack:options", Map.of(
                                "os", "Windows",
                                "osVersion", "10",
                                "buildName", "browserstack-build-1",
                                "sessionName", "Windows_Chrome_Test",
                                "projectName", "BrowserStack Sample",
                                "local", "true"
                        )
                ),
                Map.of(
                        "browserName", "Safari",
                        "bstack:options", Map.of(
                                "os", "OS X",
                                "osVersion", "Monterey",
                                "buildName", "browserstack-build-1",
                                "sessionName", "Mac_Safari_Test",
                                "projectName", "BrowserStack Sample",
                                "local", "true"
                        )
                ),
                Map.of(
                        "browserName", "Chromium",
                        "bstack:options", Map.of(
                                "deviceName", "iPhone 13",
                                "osVersion", "15",
                                "realMobile", "true",
                                "deviceOrientation", "portrait",
                                "buildName", "browserstack-build-1",
                                "sessionName", "iPhone_Chromium_Test",
                                "projectName", "BrowserStack Sample",
                                "local", "true"
                        )
                )
        );

        ExecutorService executor = Executors.newFixedThreadPool(3);

        for (Map<String, Object> capsMap : capabilitiesList) {
            executor.execute(() -> runTest(capsMap));
        }

        executor.shutdown();
    }

    public static void runTest(Map<String, Object> capsMap) {
        String username = "poojalakshminaga_xWYFPb";
        String accessKey = "CasE3r5tCCyY7VqqjTn7";

        try {
            MutableCapabilities caps = new MutableCapabilities();
            caps.setCapability("browserName", capsMap.get("browserName"));

            MutableCapabilities bstackOptions = new MutableCapabilities();
            Map<String, Object> bstackRaw = (Map<String, Object>) capsMap.get("bstack:options");

            for (Map.Entry<String, Object> entry : bstackRaw.entrySet()) {
                bstackOptions.setCapability(entry.getKey(), entry.getValue());
            }

            caps.setCapability("bstack:options", bstackOptions);

            WebDriver driver = new RemoteWebDriver(
                    new URL("https://" + username + ":" + accessKey + "@hub.browserstack.com/wd/hub"),
                    caps
            );

            driver.get("https://elpais.com/opinion/");
            Thread.sleep(5000);

            List<WebElement> articles = driver.findElements(By.cssSelector("article a"));
            Set<String> printed = new HashSet<>();
            int count = 0;

            for (WebElement article : articles) {
                if (count >= 5) break;
                String href = article.getAttribute("href");
                String title = article.getText().trim();
                if (href != null && title.length() > 10 && !printed.contains(href)) {
                    System.out.println(" URL: " + href);
                    System.out.println(" Title: " + title);
                    System.out.println("--------------------------------------");
                    printed.add(href);
                    count++;
                }
            }

            System.out.println("BrowserStack Test is Over on: " + capsMap.get("browserName"));
            driver.quit();
        } catch (Exception e) {
            System.out.println("Test failed on " + capsMap.get("browserName") + ": " + e.getMessage());
        }
    }
}
